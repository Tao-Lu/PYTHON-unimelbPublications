{% extends 'base.html' %}
{% load staticfiles  %}
# content for author details
# name, orcid, email, staff type, paper count, cited count, paper list (title)
# todo: add author photo
{% block css %}

    .clickable:hover {text-decoration: underline; cursor: pointer; color:blue; font-weight:bold}

{% endblock %}

{% block src %}
        <script src="{% static 'js/d3.v3.min.js' %}"></script>
        <script src="{% static 'js/d3.layout.js' %}"></script>
        <script src="{% static 'js/d3.geom.js' %}"></script>
        <script src="{% static 'js/detector.js' %}"></script>
        <script src="{% static 'js/CodeFlower.js' %}"></script>
        <link rel="stylesheet" href="{% static 'css/style.css' %}">

{% endblock src %}

{% block content %}

    <title>Author Details</title>

    <div class="container">
        <div class="row">
            <div id="authorDetails" style="padding: 10px; margin-top: 10px;" class="col-md-4">

                <h2 id="name">
                    {{authordetailsDict.fullName}}
                </h2>
                <h4 id="orcid">
                    ORCID: {{authordetailsDict.orcid}}
                </h4>
                <h4 id="email">
                    Email: {{authordetailsDict.email}}
                </h4>
                <h4 id="staffType">
                    Staff Type: {{authordetailsDict.staffType}}
                </h4>
                <h4 id="paperCount">
                    Document count: {{authordetailsDict.document_count}}
                </h4>
                <h4 id="citedCount">
                    Cited By Count: {{authordetailsDict.cited_by_count}}
                </h4>
            </div>

            <div id="authorRelationship" class="col-md-8" style="margin-top: 10px;">

{#                <img src="{% static 'res/background.jpg' %}" style="height: auto; max-width: 100%" class="img-responsive"/>#}
            </div>

        </div>
    <br>
    <hr style="background-color: black; height: 2px;">
    <br>
        <div class="row">
            <div class="col-md-12">
                <h2 style="margin-top:40px">Documents List</h2>
                <table id="paperlist" class="table table-striped table-bordered" style="margin-bottom:30px">
                    <thead>
                        <tr>
                            <th>Title</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyTitle">
                        {% for paper in authordetailsDict.paperlist %}
                            <tr class="title" id={{ paper.id }}>
                                <td class="clickable">{{ paper.title }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <h2 style="margin-top:30px">Co-Authors List</h2>
                <table id="coauthorlist" class="table table-striped table-bordered" style="margin-bottom:30px">
                    <thead>
                        <tr>
                            <th>Co-Authors</th>
                            <th>Co-Authored Documents</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyCoauthor">
                        {% for coauthor in authordetailsDict.coauthorlist %}
{#                            <tr class="coauthor pointer" id={{ coauthor.id }}>#}
                            <tr class="coauthor" id={{ coauthor.id }} cis={{ coauthor.authorType }}>
                                <td class="coauthorName clickable">{{ coauthor.name }}</td>
                                <td class="coauthorPaper clickable">{{ coauthor.papercount }}</td>
{#                                <td class="pointer">{{ coauthor.name }}</td>#}
{#                                <td class="pointer">{{ coauthor.papercount }}</td>#}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>


    <script>
    $(document).ready(function() {
        $('#paperlist').DataTable();
        {#$('#paperlist_paginate').hide();#}
        $('#tbodyTitle').on('click', '.title', function () {
            var paperId = $(this).closest('tr').attr('id');
            console.log(paperId)
            var host = location.host;
            var url = "http://" + host + "/paperDetails/" + paperId;
            window.location.href = url;
        });


        $('#coauthorlist').DataTable();
        {#$('#coauthorlist_paginate').hide();#}
        $('#tbodyCoauthor').on('click', '.coauthorName', function () {
            var coauthorId = $(this).closest('tr').attr('id');
            var authorType = $(this).closest('tr').attr('cis');
            console.log(coauthorId);
            console.log(authorType);

            var host = location.host;
            if (authorType == "Y") {
                var url = "http://" + host + "/authorDetails/" + coauthorId;
                window.location.href = url;
            } else {
                var url = "http://" + host + "/coAuthorDetails/" + coauthorId;
                window.location.href = url;
            }

        });

        {#jump to coAuthoredPapers#}
        $('#tbodyCoauthor').on('click', '.coauthorPaper', function () {
            var coauthorId = $(this).closest('tr').attr('id');
            var cisauthorId = location.href.split('/');
            cisauthorId = cisauthorId[cisauthorId.length - 1];
            console.log(coauthorId);
            console.log(cisauthorId);
            var host = location.host;
            var url = "http://" + host + "/coAuthoredPapers/" + cisauthorId + "/" + coauthorId;
            window.location.href = url;
        });

        {#var coauthorList = {{ authordetailsDict.coauthorlist | safe}};#}
        {#var children = [];#}
        {#for (var i in coauthorList) {#}
        {#    children.push({"name": coauthorList[i]["name"], "size": coauthorList[i]["papercount"]});}#}
        {#var authorName = "{{authordetailsDict.fullName | safe}}";#}
        {#var jsonData = {"name": authorName, "children": children};#}
        {##}
        {#var height = document.getElementById("authorRelationship").offsetHeight;#}
        {#var width = document.getElementById("authorRelationship").offsetWidth;#}
        {##}
        {#var myFlower = new CodeFlower("#authorRelationship", width, height);#}
        {#myFlower.update(jsonData);#}



        var authorName = "{{authordetailsDict.fullName | safe}}";
        var coauthorList = {{ authordetailsDict.coauthorlist | safe}};
        var children = [];
        for (var i in coauthorList) {
            children.push({"name": coauthorList[i]["name"] + ", PaperCounts: " + coauthorList[i]["papercount"], "parent": authorName});}



        var treeData = [
  {
    "name": authorName,
    "parent": "null",
    "children": children
  }
];


// ************** Generate the tree diagram	 *****************
var margin = {top: 20, right: 120, bottom: 20, left: 120},
	width = 960 - margin.right - margin.left,
	height = 500 - margin.top - margin.bottom;

var i = 0,
	duration = 750,
	root;

var tree = d3.layout.tree()
	.size([height, width]);

var diagonal = d3.svg.diagonal()
	.projection(function(d) { return [d.y, d.x]; });

var svg = d3.select("body").append("svg")
	.attr("width", width + margin.right + margin.left)
	.attr("height", height + margin.top + margin.bottom)
  .append("g")
	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

root = treeData[0];
root.x0 = height / 2;
root.y0 = 0;

update(root);

d3.select(self.frameElement).style("height", "500px");

function update(source) {

  // Compute the new tree layout.
  var nodes = tree.nodes(root).reverse(),
	  links = tree.links(nodes);

  // Normalize for fixed-depth.
  nodes.forEach(function(d) { d.y = d.depth * 180; });

  // Update the nodes…
  var node = svg.selectAll("g.node")
	  .data(nodes, function(d) { return d.id || (d.id = ++i); });

  // Enter any new nodes at the parent's previous position.
  var nodeEnter = node.enter().append("g")
	  .attr("class", "node")
	  .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
	  .on("click", click);

  nodeEnter.append("circle")
	  .attr("r", 1e-6)
	  .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

  nodeEnter.append("text")
	  .attr("x", function(d) { return d.children || d._children ? -13 : 13; })
	  .attr("dy", ".35em")
	  .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
	  .text(function(d) { return d.name; })
	  .style("fill-opacity", 1e-6);

  // Transition nodes to their new position.
  var nodeUpdate = node.transition()
	  .duration(duration)
	  .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

  nodeUpdate.select("circle")
	  .attr("r", 10)
	  .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

  nodeUpdate.select("text")
	  .style("fill-opacity", 1);

  // Transition exiting nodes to the parent's new position.
  var nodeExit = node.exit().transition()
	  .duration(duration)
	  .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
	  .remove();

  nodeExit.select("circle")
	  .attr("r", 1e-6);

  nodeExit.select("text")
	  .style("fill-opacity", 1e-6);

  // Update the links…
  var link = svg.selectAll("path.link")
	  .data(links, function(d) { return d.target.id; });

  // Enter any new links at the parent's previous position.
  link.enter().insert("path", "g")
	  .attr("class", "link")
	  .attr("d", function(d) {
		var o = {x: source.x0, y: source.y0};
		return diagonal({source: o, target: o});
	  });

  // Transition links to their new position.
  link.transition()
	  .duration(duration)
	  .attr("d", diagonal);

  // Transition exiting nodes to the parent's new position.
  link.exit().transition()
	  .duration(duration)
	  .attr("d", function(d) {
		var o = {x: source.x, y: source.y};
		return diagonal({source: o, target: o});
	  })
	  .remove();

  // Stash the old positions for transition.
  nodes.forEach(function(d) {
	d.x0 = d.x;
	d.y0 = d.y;
  });
}

// Toggle children on click.
function click(d) {
  if (d.children) {
	d._children = d.children;
	d.children = null;
  } else {
	d.children = d._children;
	d._children = null;
  }
  update(d);
}
    });

    </script>


{% endblock %}